{% extends "base.html" %}

{% block title %}Monitorando Execu√ß√£o - {{ execucao_id }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    
    <!-- Cabe√ßalho com status geral -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-semibold mb-2">Monitorando Execu√ß√£o</h2>
                <p class="text-sm text-gray-500 font-mono">{{ execucao_id }}</p>
            </div>
            <div class="text-right">
                <div id="connectionStatus" class="text-sm mb-2">
                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-1"></span>
                    <span>Conectando...</span>
                </div>
                <p class="font-semibold text-lg" id="geralStatus">Inicializando...</p>
                <p class="text-sm text-gray-500" id="geralProgresso">Progresso: 0%</p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>

    <!-- Status dos Arquivos -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Status dos Arquivos</h3>
        
        <div id="filesStatusContainer" class="space-y-4">
            {% for arquivo in arquivos %}
            <div id="file-{{ arquivo.arquivo | replace('.', '_') }}" 
                 class="p-4 border rounded-lg bg-gray-50 transition-all duration-300">
                <div class="flex items-center justify-between mb-2">
                    <p class="font-medium truncate pr-4">{{ arquivo.arquivo }}</p>
                    <span class="badge badge-info text-xs status-badge">Aguardando</span>
                </div>
                <div class="text-sm text-gray-600">
                    <p class="etapa-text">Pronto para iniciar</p>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                        <div class="progress-bar bg-blue-500 h-1.5 rounded-full transition-all duration-500" 
                             style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Debug (pode remover em produ√ß√£o) -->
    <div class="mt-6 bg-gray-100 rounded-lg p-4">
        <h4 class="font-semibold mb-2 text-sm">Debug - √öltimas Mensagens:</h4>
        <div id="debugMessages" class="text-xs font-mono space-y-1 max-h-32 overflow-y-auto"></div>
    </div>

</div>

<script>
(function() {
    const execucaoId = '{{ execucao_id }}';
    const streamUrl = `/api/execucoes/${execucaoId}/stream`;
    
    let eventSource = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // Elementos DOM
    const connectionStatus = document.getElementById('connectionStatus');
    const geralStatus = document.getElementById('geralStatus');
    const geralProgresso = document.getElementById('geralProgresso');
    const progressBar = document.getElementById('progressBar');
    const debugMessages = document.getElementById('debugMessages');
    
    // Fun√ß√µes auxiliares
    function addDebugMessage(msg) {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        debugMessages.appendChild(line);
        debugMessages.scrollTop = debugMessages.scrollHeight;
        
        // Manter apenas √∫ltimas 20 mensagens
        while (debugMessages.children.length > 20) {
            debugMessages.removeChild(debugMessages.firstChild);
        }
    }
    
    function updateConnectionStatus(status, color) {
        const dot = connectionStatus.querySelector('.rounded-full');
        const text = connectionStatus.querySelector('span:last-child');
        
        dot.className = `inline-block w-2 h-2 rounded-full ${color} mr-1`;
        text.textContent = status;
    }
    
    function getBadgeClass(status) {
        const classes = {
            'aguardando': 'badge-info',
            'processando': 'badge-info',
            'concluido': 'badge-success',
            'falha': 'badge-error'
        };
        return classes[status.toLowerCase()] || 'badge-info';
    }
    
    function getProgressBarClass(status) {
        const classes = {
            'aguardando': 'bg-gray-500',
            'processando': 'bg-blue-500',
            'concluido': 'bg-green-500',
            'falha': 'bg-red-500'
        };
        return classes[status.toLowerCase()] || 'bg-blue-500';
    }
    
    function updateFileStatus(data) {
        const fileId = data.arquivo.replace(/\./g, '_');
        const fileElement = document.getElementById(`file-${fileId}`);
        
        if (!fileElement) {
            addDebugMessage(`‚ö†Ô∏è Element not found: file-${fileId}`);
            return;
        }
        
        const etapaText = fileElement.querySelector('.etapa-text');
        const progressBarEl = fileElement.querySelector('.progress-bar');
        const badge = fileElement.querySelector('.status-badge');
        
        if (data.type === 'file_progress') {
            // Atualizar progresso
            if (etapaText) {
                etapaText.textContent = data.etapa_atual || 'Processando...';
            }
            if (progressBarEl) {
                progressBarEl.style.width = `${data.progresso_percentual || 0}%`;
                progressBarEl.className = `progress-bar h-1.5 rounded-full transition-all duration-500 ${getProgressBarClass('processando')}`;
            }
            if (badge) {
                badge.className = `badge ${getBadgeClass('processando')} text-xs status-badge`;
                badge.textContent = 'Processando';
            }
            
            addDebugMessage(`üìä ${data.arquivo}: ${data.progresso_percentual}% - ${data.etapa_atual}`);
            
        } else if (data.type === 'file_result') {
            // Resultado final
            const status = data.status;
            
            if (etapaText) {
                etapaText.textContent = status === 'concluido' 
                    ? `‚úÖ Conclu√≠do: ${data.output_gerado}` 
                    : `‚ùå Erro: ${data.erro || 'Desconhecido'}`;
            }
            if (progressBarEl) {
                progressBarEl.style.width = '100%';
                progressBarEl.className = `progress-bar h-1.5 rounded-full transition-all duration-500 ${getProgressBarClass(status)}`;
            }
            if (badge) {
                badge.className = `badge ${getBadgeClass(status)} text-xs status-badge`;
                badge.textContent = status === 'concluido' ? 'Conclu√≠do' : 'Falha';
            }
            
            addDebugMessage(`${status === 'concluido' ? '‚úÖ' : '‚ùå'} ${data.arquivo}: ${status}`);
        }
    }
    
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }
        
        addDebugMessage(`üîå Connecting to: ${streamUrl}`);
        updateConnectionStatus('Conectando...', 'bg-yellow-500');
        
        eventSource = new EventSource(streamUrl);
        
        eventSource.onopen = function() {
            addDebugMessage('‚úÖ SSE connection established');
            updateConnectionStatus('Conectado', 'bg-green-500');
            reconnectAttempts = 0;
            
            geralStatus.textContent = 'Processando...';
        };
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addDebugMessage(`üì® Received: ${data.type}`);
                
                if (data.type === 'file_progress' || data.type === 'file_result') {
                    updateFileStatus(data);
                    
                } else if (data.type === 'full_status') {
                    // Status completo inicial
                    if (data.payload && data.payload.arquivos) {
                        data.payload.arquivos.forEach(arquivo => {
                            updateFileStatus({
                                type: 'file_progress',
                                arquivo: arquivo.arquivo,
                                etapa_atual: arquivo.etapa_atual,
                                progresso_percentual: arquivo.progresso_percentual
                            });
                        });
                    }
                    
                } else if (data.type === 'geral_status') {
                    // Status geral da execu√ß√£o
                    geralStatus.textContent = data.status || 'Processando';
                    if (data.progresso_percentual !== undefined) {
                        geralProgresso.textContent = `Progresso: ${data.progresso_percentual}%`;
                        progressBar.style.width = `${data.progresso_percentual}%`;
                    }
                }
                
            } catch (error) {
                console.error('Error parsing SSE data:', error);
                addDebugMessage(`‚ùå Parse error: ${error.message}`);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('SSE error:', error);
            addDebugMessage('‚ùå SSE connection error');
            updateConnectionStatus('Desconectado', 'bg-red-500');
            
            eventSource.close();
            
            // Tentar reconectar
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                addDebugMessage(`üîÑ Reconnecting in ${delay/1000}s (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                
                setTimeout(connectSSE, delay);
            } else {
                addDebugMessage('‚ùå Max reconnection attempts reached');
                updateConnectionStatus('Falha na conex√£o', 'bg-red-500');
                geralStatus.textContent = 'Erro de conex√£o';
            }
        };
    }
    
    // Iniciar conex√£o
    connectSSE();
    
    // Limpar ao sair da p√°gina
    window.addEventListener('beforeunload', () => {
        if (eventSource) {
            eventSource.close();
        }
    });
    
    // Bot√£o para reconectar manualmente (adicionar se necess√°rio)
    window.reconnectSSE = function() {
        reconnectAttempts = 0;
        connectSSE();
    };
    
})();
</script>
{% endblock %}